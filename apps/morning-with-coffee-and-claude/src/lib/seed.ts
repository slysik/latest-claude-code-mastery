import type { ClassifiedItem, EcosystemEntry, ChangelogHighlight, ReviewTelemetryEntry } from './types'
import {
  insertItems,
  upsertSentimentSnapshot,
  upsertEcosystemEntries,
  upsertChangelogHighlights,
  upsertReviewTelemetry,
  getLatestItems,
} from './db'

function getReleaseItems(today: string, now: string): ClassifiedItem[] {
  return [
    {
      date: today,
      source: 'github',
      category: 'feature',
      title: 'v2.1.32 — Claude Opus 4.6 & Agent Teams',
      url: 'https://github.com/anthropics/claude-code/releases/tag/v2.1.32',
      author: 'Anthropic',
      excerpt:
        'Claude Opus 4.6 is now available\nResearch preview agent teams for multi-agent collaboration\nAutomatic memory recording and recall\nSummarize from here for partial conversation summarization\nSkill character budget now scales with context window',
      thumbnailUrl: null,
      engagementScore: 0.97,
      rawMetrics: { stars: 12400 },
      sentiment: 'positive',
      sentimentConfidence: 0.95,
      topicTags: ['release', 'opus-4.6', 'agent-teams'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'github',
      category: 'feature',
      title: 'v2.1.36 — Fast Mode for Opus 4.6',
      url: 'https://github.com/anthropics/claude-code/releases/tag/v2.1.36',
      author: 'Anthropic',
      excerpt:
        'Fast mode is now available for Opus 4.6\nSame model with faster output\nToggle with /fast command',
      thumbnailUrl: null,
      engagementScore: 0.89,
      rawMetrics: { stars: 12400 },
      sentiment: 'positive',
      sentimentConfidence: 0.92,
      topicTags: ['release', 'fast-mode', 'opus-4.6'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'github',
      category: 'feature',
      title: 'v2.1.38 — Terminal Renderer & Permission Fixes',
      url: 'https://github.com/anthropics/claude-code/releases/tag/v2.1.38',
      author: 'Anthropic',
      excerpt:
        'Fixed VS Code terminal scroll-to-top regression\nFixed Tab key queueing slash commands instead of autocompleting\nFixed bash permission matching for env var wrappers\nImproved heredoc delimiter parsing',
      thumbnailUrl: null,
      engagementScore: 0.72,
      rawMetrics: { stars: 12400 },
      sentiment: 'positive',
      sentimentConfidence: 0.88,
      topicTags: ['release', 'bugfix', 'security'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
  ]
}

let seeded = false

export async function seedDatabase(): Promise<void> {
  if (seeded) return

  const today = new Date().toISOString().split('T')[0]
  const now = new Date().toISOString()

  // Always upsert release items (ON CONFLICT is safe to re-run)
  const releaseItems: ClassifiedItem[] = getReleaseItems(today, now)
  await insertItems(releaseItems)

  // Check if full seed data already exists
  const existing = await getLatestItems(undefined, 1)
  if (existing.length > releaseItems.length) {
    seeded = true
    return
  }

  const sampleItems: ClassifiedItem[] = [
    {
      date: today,
      source: 'reddit',
      category: 'tip',
      title: 'Claude Code hooks can auto-validate your Python on every save',
      url: 'https://reddit.com/r/ClaudeAI/sample-1',
      author: 'u/hooks_enthusiast',
      excerpt:
        'PostToolUse hooks with Ruff validators catch lint errors before they pile up. Game changer for large refactors.',
      thumbnailUrl: null,
      engagementScore: 0.92,
      rawMetrics: { upvotes: 847, comments: 156 },
      sentiment: 'positive',
      sentimentConfidence: 0.94,
      topicTags: ['hooks', 'validation', 'python'],
      oneLineQuote: 'Game changer for large refactors.',
      isTip: true,
      tipConfidence: 0.91,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'youtube',
      category: 'video',
      title: 'Building a Full MCP Server from Scratch with Claude Code',
      url: 'https://youtube.com/watch?v=sample-2',
      author: 'AI Engineering Daily',
      excerpt:
        'Step-by-step walkthrough of creating an MCP server that connects Claude to your internal APIs.',
      thumbnailUrl: null,
      engagementScore: 0.85,
      rawMetrics: { views: 42300, likes: 1890 },
      sentiment: 'positive',
      sentimentConfidence: 0.88,
      topicTags: ['mcp', 'tutorial', 'api'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'github',
      category: 'plugin',
      title: 'claude-code-memory: Persistent memory layer for Claude Code sessions',
      url: 'https://github.com/example/claude-code-memory',
      author: 'devtools-collective',
      excerpt:
        'Adds long-term memory to Claude Code via a local SQLite database and smart context injection.',
      thumbnailUrl: null,
      engagementScore: 0.78,
      rawMetrics: { stars: 1240, forks: 89 },
      sentiment: 'positive',
      sentimentConfidence: 0.82,
      topicTags: ['memory', 'context', 'plugin'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'anthropic',
      category: 'news',
      title: 'Claude Code 1.0.30: Agent Teams and Enhanced Hook Lifecycle',
      url: 'https://docs.anthropic.com/en/changelog/sample-4',
      author: 'Anthropic',
      excerpt:
        'New release adds experimental agent teams, improved context management, and 3 new hook events.',
      thumbnailUrl: null,
      engagementScore: 0.95,
      rawMetrics: {},
      sentiment: 'positive',
      sentimentConfidence: 0.96,
      topicTags: ['release', 'agent-teams', 'hooks'],
      oneLineQuote: 'Experimental agent teams are now available.',
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'x',
      category: 'tip',
      title: 'Tip: Use PreCompact hook to save transcripts before context overflow',
      url: 'https://x.com/sample-user/status/sample-5',
      author: '@claude_tips',
      excerpt:
        'The PreCompact hook fires right before Claude compresses your context. Perfect for backing up the full conversation.',
      thumbnailUrl: null,
      engagementScore: 0.71,
      rawMetrics: { likes: 234, retweets: 89 },
      sentiment: 'positive',
      sentimentConfidence: 0.85,
      topicTags: ['precompact', 'context', 'tip'],
      oneLineQuote: 'Perfect for backing up the full conversation.',
      isTip: true,
      tipConfidence: 0.88,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'substack',
      category: 'news',
      title: 'The State of AI Coding Assistants: Claude Code vs Cursor vs Copilot',
      url: 'https://ainews.substack.com/p/sample-6',
      author: 'AI Weekly Digest',
      excerpt:
        'Comprehensive comparison of agentic coding tools. Claude Code leads in autonomous task completion.',
      thumbnailUrl: null,
      engagementScore: 0.82,
      rawMetrics: { likes: 567 },
      sentiment: 'neutral',
      sentimentConfidence: 0.72,
      topicTags: ['comparison', 'coding-assistants', 'analysis'],
      oneLineQuote: 'Claude Code leads in autonomous task completion.',
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'reddit',
      category: 'feature',
      title: 'SubagentStart/SubagentStop hooks are incredibly useful for logging',
      url: 'https://reddit.com/r/ClaudeAI/sample-7',
      author: 'u/subagent_watcher',
      excerpt:
        'You can track every subagent spawn and completion with structured logs. Makes debugging team workflows way easier.',
      thumbnailUrl: null,
      engagementScore: 0.68,
      rawMetrics: { upvotes: 312, comments: 78 },
      sentiment: 'positive',
      sentimentConfidence: 0.89,
      topicTags: ['subagent', 'logging', 'debugging'],
      oneLineQuote: 'Makes debugging team workflows way easier.',
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'github',
      category: 'plugin',
      title: 'mcp-everything: Universal MCP server connecting 50+ services',
      url: 'https://github.com/example/mcp-everything',
      author: 'mcp-community',
      excerpt:
        'One MCP server to connect Claude Code to Slack, Linear, Notion, GitHub, and 47 other services.',
      thumbnailUrl: null,
      engagementScore: 0.88,
      rawMetrics: { stars: 3420, forks: 245 },
      sentiment: 'positive',
      sentimentConfidence: 0.79,
      topicTags: ['mcp', 'integrations', 'productivity'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'youtube',
      category: 'video',
      title: 'Claude Code Agent Teams Deep Dive: Builder/Validator Pattern',
      url: 'https://youtube.com/watch?v=sample-9',
      author: 'DevTools Weekly',
      excerpt:
        'How to set up builder and validator agents that work together for higher-quality code output.',
      thumbnailUrl: null,
      engagementScore: 0.74,
      rawMetrics: { views: 18700, likes: 892 },
      sentiment: 'positive',
      sentimentConfidence: 0.86,
      topicTags: ['agent-teams', 'builder-validator', 'tutorial'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'x',
      category: 'news',
      title: 'Anthropic API pricing update: Haiku gets 40% cheaper',
      url: 'https://x.com/AnthropicAI/status/sample-10',
      author: '@AnthropicAI',
      excerpt:
        'Haiku model pricing reduced by 40%, making AI-powered pipelines significantly more affordable.',
      thumbnailUrl: null,
      engagementScore: 0.91,
      rawMetrics: { likes: 2340, retweets: 890 },
      sentiment: 'positive',
      sentimentConfidence: 0.93,
      topicTags: ['pricing', 'haiku', 'api'],
      oneLineQuote: null,
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'reddit',
      category: 'tip',
      title: 'Use CLAUDE_ENV_FILE in setup hook to persist env vars across sessions',
      url: 'https://reddit.com/r/ClaudeAI/sample-11',
      author: 'u/env_hacker',
      excerpt:
        'The setup hook can write to CLAUDE_ENV_FILE and those variables persist for the entire session. No more re-exporting.',
      thumbnailUrl: null,
      engagementScore: 0.65,
      rawMetrics: { upvotes: 198, comments: 45 },
      sentiment: 'positive',
      sentimentConfidence: 0.87,
      topicTags: ['setup', 'environment', 'tip'],
      oneLineQuote: 'No more re-exporting.',
      isTip: true,
      tipConfidence: 0.93,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'substack',
      category: 'news',
      title: 'Why Claude Code hooks matter more than you think',
      url: 'https://devblog.substack.com/p/sample-12',
      author: 'The Pragmatic Engineer',
      excerpt:
        'Hooks turn Claude Code from a smart autocomplete into a programmable development platform.',
      thumbnailUrl: null,
      engagementScore: 0.79,
      rawMetrics: { likes: 423 },
      sentiment: 'positive',
      sentimentConfidence: 0.91,
      topicTags: ['hooks', 'opinion', 'platform'],
      oneLineQuote:
        'Hooks turn Claude Code from a smart autocomplete into a programmable development platform.',
      isTip: false,
      tipConfidence: null,
      communityAction: null,
      patternType: null,
      patternRecipe: null,
      fetchedAt: now,
      createdAt: now,
    },
    {
      date: today,
      source: 'reddit',
      category: 'tip',
      title: 'Multi-model review pipeline: Kimi + Ollama + Codex + Gemini before Claude',
      url: 'https://reddit.com/r/ClaudeAI/sample-pattern-1',
      author: 'u/review_engineer',
      excerpt:
        'We run local models first (free + fast), then cross-model reviews, then Claude for architecture. Catches 90% of issues before spending API credits.',
      thumbnailUrl: null,
      engagementScore: 0.88,
      rawMetrics: { upvotes: 523, comments: 112 },
      sentiment: 'positive',
      sentimentConfidence: 0.92,
      topicTags: ['multi-model', 'review', 'workflow'],
      oneLineQuote: 'Catches 90% of issues before spending API credits.',
      isTip: true,
      tipConfidence: 0.95,
      communityAction: 'Set up plan_w_team_v3 with 7 review stages: 0A (Kimi), 0B (Ollama), 1A (Codex), 1C (Gemini), 1B (Claude), 2 (Implementation), 3 (Quality Gate)',
      patternType: 'model_mix',
      patternRecipe: '1. Run Kimi (local) for simplicity/architecture review\n2. Run Ollama (local) for security review\n3. Run Codex (API) for cross-model code review\n4. Run Gemini (API) for another cross-model perspective\n5. Run Claude for final architecture synthesis',
      fetchedAt: now,
      createdAt: now,
    },
    ...getReleaseItems(today, now),
  ]

  const ecosystemEntries: EcosystemEntry[] = [
    {
      name: 'claude-code-hooks-mastery',
      type: 'hook',
      author: 'slysik',
      description:
        'Production reference for all 13 Claude Code lifecycle hooks with agent orchestration.',
      githubUrl: 'https://github.com/slysik/claude-code-hooks-mastery',
      stars: 342,
      lastUpdated: now,
      categoryTags: ['hooks', 'reference', 'agents'],
      mentionCount: 28,
      agentMeta: null,
    },
    {
      name: 'mcp-server-sqlite',
      type: 'mcp_server',
      author: 'anthropics',
      description:
        'MCP server providing SQLite database access to Claude Code.',
      githubUrl: 'https://github.com/modelcontextprotocol/servers',
      stars: 8920,
      lastUpdated: now,
      categoryTags: ['mcp', 'database', 'sqlite'],
      mentionCount: 156,
      agentMeta: null,
    },
    {
      name: 'claude-code-action',
      type: 'plugin',
      author: 'anthropics',
      description:
        'GitHub Action to run Claude Code in CI/CD pipelines for automated code review.',
      githubUrl: 'https://github.com/anthropics/claude-code-action',
      stars: 2150,
      lastUpdated: now,
      categoryTags: ['ci-cd', 'github-actions', 'automation'],
      mentionCount: 89,
      agentMeta: null,
    },
    {
      name: 'claude-code-router',
      type: 'skill',
      author: 'ai-tools-lab',
      description:
        'Smart routing skill that delegates tasks to the best-fit Claude model tier.',
      githubUrl: 'https://github.com/ai-tools-lab/claude-code-router',
      stars: 567,
      lastUpdated: now,
      categoryTags: ['routing', 'optimization', 'skill'],
      mentionCount: 34,
      agentMeta: null,
    },
    {
      name: 'mcp-playwright',
      type: 'mcp_server',
      author: 'anthropics',
      description:
        'Browser automation MCP server enabling Claude Code to interact with web pages.',
      githubUrl: 'https://github.com/anthropics/mcp-playwright',
      stars: 4210,
      lastUpdated: now,
      categoryTags: ['mcp', 'browser', 'automation'],
      mentionCount: 112,
      agentMeta: null,
    },
    {
      name: 'team-builder-validator',
      type: 'agent_config',
      author: 'slysik',
      description:
        'Builder/Validator agent team pattern — implementation agent with Ruff+Ty validation, paired with read-only verifier.',
      githubUrl: 'https://github.com/slysik/claude-code-hooks-mastery',
      stars: 342,
      lastUpdated: now,
      categoryTags: ['agents', 'teams', 'validation'],
      mentionCount: 15,
      agentMeta: {
        configType: 'agent',
        modelTier: 'opus',
        toolRestrictions: ['Read', 'Glob', 'Grep', 'Bash'],
      },
    },
  ]

  await insertItems(sampleItems)

  // Find the top positive item URL for the snapshot
  const topPositiveUrl = sampleItems.find(
    (i) => i.sentiment === 'positive' && i.engagementScore >= 0.9,
  )?.url ?? null

  await upsertSentimentSnapshot({
    date: today,
    positivePct: 75,
    neutralPct: 17,
    negativePct: 8,
    sampleSize: sampleItems.length,
    topPositiveId: null, // Will resolve from items table in actual pipeline
    topNegativeId: null,
    summary:
      'Strong positive sentiment across the Claude Code ecosystem today. New hook patterns and MCP integrations driving excitement. Pricing updates well received.',
  })

  await upsertEcosystemEntries(ecosystemEntries)

  // Changelog highlights sample data
  const changelogHighlights: ChangelogHighlight[] = [
    {
      date: today,
      releaseTag: 'v2.1.38',
      prevReleaseTag: 'v2.1.36',
      releaseUrl: 'https://github.com/anthropics/claude-code/releases/tag/v2.1.38',
      hookRelevance: ['PreToolUse', 'PermissionRequest'],
      highlights: [
        'Fixed VS Code terminal scroll-to-top regression',
        'Fixed Tab key queueing slash commands instead of autocompleting',
        'Fixed bash permission matching for env var wrappers',
        'Improved heredoc delimiter parsing',
      ],
      breakingChanges: [],
      diffStats: { filesChanged: 23, additions: 412, deletions: 187 },
      rawBody: 'Bug fixes and permission improvements.',
      fetchedAt: now,
    },
    {
      date: today,
      releaseTag: 'v2.1.36',
      prevReleaseTag: 'v2.1.32',
      releaseUrl: 'https://github.com/anthropics/claude-code/releases/tag/v2.1.36',
      hookRelevance: [],
      highlights: [
        'Fast mode now available for Opus 4.6',
        'Same model with faster output',
        'Toggle with /fast command',
      ],
      breakingChanges: [],
      diffStats: { filesChanged: 8, additions: 156, deletions: 34 },
      rawBody: 'Fast mode for Opus 4.6.',
      fetchedAt: now,
    },
  ]
  await upsertChangelogHighlights(changelogHighlights)

  // Review telemetry sample data
  const reviewTelemetryEntries: ReviewTelemetryEntry[] = [
    {
      date: today,
      planId: 'sample-plan-001',
      reviewId: '0A',
      modelName: 'llama3.2:3b',
      reviewType: 'simplicity',
      criticalIssues: 1,
      improvements: 3,
      suggestions: 5,
      strengths: 4,
      verdict: 'PASS',
      confidenceScore: 0.72,
      durationMs: 2340,
      fetchedAt: now,
    },
    {
      date: today,
      planId: 'sample-plan-001',
      reviewId: '0B',
      modelName: 'llama3.2:3b',
      reviewType: 'security',
      criticalIssues: 0,
      improvements: 2,
      suggestions: 4,
      strengths: 3,
      verdict: 'PASS',
      confidenceScore: 0.68,
      durationMs: 1890,
      fetchedAt: now,
    },
    {
      date: today,
      planId: 'sample-plan-001',
      reviewId: '1A',
      modelName: 'codex-mini-latest',
      reviewType: 'code-review',
      criticalIssues: 2,
      improvements: 5,
      suggestions: 3,
      strengths: 6,
      verdict: 'CONDITIONAL PASS',
      confidenceScore: 0.85,
      durationMs: 8450,
      fetchedAt: now,
    },
    {
      date: today,
      planId: 'sample-plan-001',
      reviewId: '1C',
      modelName: 'gemini-2.5-flash',
      reviewType: 'cross-model',
      criticalIssues: 1,
      improvements: 4,
      suggestions: 6,
      strengths: 5,
      verdict: 'CONDITIONAL PASS',
      confidenceScore: 0.81,
      durationMs: 6120,
      fetchedAt: now,
    },
  ]
  await upsertReviewTelemetry(reviewTelemetryEntries)

  seeded = true
}
